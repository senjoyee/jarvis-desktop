Database Refresh: SAP NetWeaver 7.5 (ABAP) on Oracle

Purpose
Provide a practical, safe, high-level procedure to refresh the database of an SAP ABAP system (NetWeaver 7.5) from a source (production) Oracle database into a target system (e.g., QA, DEV). This is a database-only refresh (system copy of database content).

Important notes and prerequisites
- This is a high-level procedure. Always consult and follow the official SAP System Copy documentation (Software Provisioning Manager / System Copy guides) and Oracle DBA best practices for your platform.
- Execute only with joint SAP BASIS and Oracle DBA authorization and during an agreed maintenance window.
- Verify software/kernel/DB compatibility: target SAP NetWeaver 7.5 kernel and database client must be compatible with the Oracle version used.
- Ensure full, tested backups of both source and target (before changes) exist and are restorable.
- Record current system parameters, hostnames, SIDs, listener and TNS configuration, SAP profiles, and instance numbers.
- Notify users and dependent systems (interfaces) about the refresh and expected downtime.

References (official SAP docs to read before start)
- SAP Help Portal: System Copy (Software Provisioning Manager) — look for Database-only / Refresh options for ABAP NetWeaver 7.5
  https://help.sap.com/viewer (search "System Copy" / "Database Only - Refresh")
- SAP: "Oracle: Performing Specific Actions" (contains steps like sapdba_role.sql and brbackup usage)
  https://help.sap.com/docs/SLTOOLSET/6a710817c8a14ab2829c19328a1063bb/2d63389d13de467da1deda92b8d6f4ac.html
- SAP System Copy guides (UNIX / Windows) — SWPM system copy PDF for ABAP
  https://help.sap.com/viewer (search "System Copy for SAP Systems Based on the Application Server ABAP")

High-level steps
1) Plan and prepare
   - Agree scope: full DB refresh vs subset (schemas). Identify source database (production) and target SAP system (SID, instance numbers).
   - Identify method: RMAN backup/restore, Oracle Data Pump (expdp/impdp), or Oracle duplication (RMAN duplicate) depending on size, RTO, and DB team preferences.
   - Prepare a runbook with exact commands, expected time, rollback steps.

2) Pre-refresh checks and backups
   - Take an additional backup of the target database (so it can be restored if needed).
     Example: use RMAN or brbackup (SAP BR*Tools) to create a full backup of the target.
   - Export important SAP configuration/transport-related data if needed.
   - Stop background jobs on target (batch, interfaces) and ensure no external processes write to the target DB during restore.

3) Stop SAP on the target
   - Log on as <SID>adm and stop the application server(s) and message server.
     Example (Unix/Linux):
       su - <SID>adm
       stopsap r3         (or use sapcontrol/sapservices depending on your platform)
   - Verify all work processes and dispatcher are stopped.

4) Prepare the Oracle target environment
   - If restoring into the same DB name/SID, ensure Oracle environment variables (ORACLE_HOME, ORACLE_SID) are set correctly for the restore.
   - If you will replace the entire database, either drop and recreate the target DB or prepare an empty database for import.
   - Ensure listener/tnsnames entries and Oracle directories (DATA_PUMP_DIR etc.) are configured.
   - Ensure sufficient tablespace space and file system space for the restored database and SAP application files.

5) Export/backup from source (Production) DB
   - For RMAN-based strategy: take an RMAN backup (or use an existing recent backup) and make it available to the target (via backup catalog, shared storage, or a transport mechanism).
   - For Data Pump strategy (expdp): on source run:
       expdp system/<pwd>@PROD full=Y directory=DATA_PUMP_DIR dumpfile=prod_full_%U.dmp logfile=expdp_prod_full.log parallel=N
   - Ensure consistent export (export during a quiet period or use Oracle's consistent export methods). Coordinate with Oracle DBA.

6) Restore/import to the target Oracle DB
   - RMAN restore/duplicate example (simplified):
       rman target /
       RMAN> RESTORE CONTROLFILE FROM '<backup_location>';
       RMAN> ALTER DATABASE MOUNT;
       RMAN> RESTORE DATABASE; -- follow with RECOVER if needed
       RMAN> ALTER DATABASE OPEN RESETLOGS;
     (Exact RMAN sequence depends on how backup was taken and whether you duplicate to a different DB name.)
   - Data Pump import (impdp) example if using expdp/impdp:
       impdp system/<pwd>@TARGET full=Y directory=DATA_PUMP_DIR dumpfile=prod_full_01.dmp logfile=impdp_prod_full.log parallel=N
   - Validate that all SAP schemas (e.g., DDIC, SAP<SID>, etc.) were imported correctly and that tablespaces and objects are present.

7) Post-restore Oracle tasks
   - Recreate or validate SAP Oracle users and roles. As noted by SAP docs, run sapdba_role.sql if required (SAPDBA role updates).
     Example (as <SID>adm on Windows/Oracle home):
       cd %ORACLE_HOME%/database
       sqlplus /nolog @sapdba_role <SAPSCHEMA-ID>
   - Recreate/validate PL/SQL objects, grants, profiles. Run any SAP-provided scripts required after DB import.
   - Check/adjust initialization parameters (pfile/spfile) and redo/archivelog settings. If you changed ARCHIVELOG state during operations, set to required mode.
   - Ensure listeners and TNS names point to the restored DB.

8) Recreate SAP-specific config files on target if needed
   - If the DB SID or host changed, update the SAP DB connection entries in the SAP profile and environment, e.g.:
     - /usr/sap/<SID>/SYS/profile/*
     - J2EE or other connectors if present
   - Update entries in /etc/services or specific SAP entries that reference the DB host/instance.

9) Start database and run consistency checks
   - Start Oracle database and open it in the expected mode.
   - Check for invalid objects in Oracle (select count(*) from dba_objects where status='INVALID'). Compile invalid objects as needed.
   - Verify tablespace sizes, free space, and online status.

10) Start SAP on target and perform SAP post-processing
   - Start SAP instance(s): startsap r3 (or sapcontrol start if appropriate) as <SID>adm.
   - Run SAP post-copy steps recommended by SWPM/System Copy guide. Typical tasks include:
     - Clear SAP buffers (transaction STMS?); run report 'RZ10' or use SAP tools to refresh settings.
     - Run SGEN (transaction) to regenerate ABAP objects if required.
     - Run BR*Tools database checks (brconnect, brspace) to check database health.
   - Execute post-copy activities described in SAP system copy documentation (SCC4 adjustments, RFC and logical system checks, change client settings if you refreshed a client, reset transport routes if necessary).

11) SAP-specific housekeeping
   - Remove/synchronize any host-specific settings that were copied from production (e.g., RFC destinations, external file paths, printer definitions, email settings, IDoc partners) to avoid accidentally sending data to productive systems.
   - Change logical system names and client settings if the target is a non-productive system. Use transaction SCC4, R3trans, or SWPM postprocessing steps where required.
   - Consider changing passwords for critical SAP/DB users in the refreshed target to avoid security issues.

12) Verification and testing
   - Check SAP system status (SM04, SM51, ST22 short dumps, system log /usr/sap/<SID>/D00/work/*).
   - Execute functional smoke tests for critical transactions and interfaces.
   - Validate that background jobs and interfaces work correctly in the refreshed environment (but do not accidentally update production systems).

13) Final tasks
   - Re-enable scheduled jobs and interfaces as needed.
   - Document the refresh outcome, times, and any deviations from the plan.
   - Keep the target backup after refresh for rollback if needed.

Caveats and recommendations
- Use SWPM (Software Provisioning Manager) system copy when possible—the tool provides guided steps and automates many post-processing actions for SAP systems.
- For large databases, RMAN duplication may be the fastest approach; coordinate with Oracle DBAs for optimal restore strategy (transportable tablespaces, standby database conversion, RMAN duplicate using active database duplication, etc.).
- Never expose production connection details in a non-production environment. Remove or adapt integration endpoints and credentials after refresh.
- Always follow the step-by-step instructions in the official SAP System Copy/Refresh guide relevant to your NetWeaver SP level and platform (UNIX/Windows) and consult SAP Notes where needed.

If you want
- I can fetch the specific SWPM "System Copy (Database-only)" step-by-step page and append it to this file.
- I can also include sample RMAN or expdp/impdp scripts tailored to your environment if you provide Oracle versions, DB names, and whether you prefer RMAN or Data Pump.

End of document
