{"version":3,"sources":["../src/hooks/useAnimateAtoms.ts"],"sourcesContent":["'use client';\n\nimport * as React from 'react';\n\nimport { isAnimationRunning } from '../utils/isAnimationRunning';\nimport type { AnimationHandle, AtomMotion } from '../types';\n\nexport const DEFAULT_ANIMATION_OPTIONS: KeyframeEffectOptions = {\n  fill: 'forwards',\n};\n\n// A motion atom's default reduced motion is a simple 1 ms duration.\n// But an atom can define a custom reduced motion, overriding keyframes and/or params like duration, easing, iterations, etc.\nconst DEFAULT_REDUCED_MOTION_ATOM: NonNullable<AtomMotion['reducedMotion']> = {\n  duration: 1,\n};\n\n/**\n * Creates an animation handle that controls multiple animations.\n * Is used to avoid leaking \"element\" references from the hook.\n *\n * @param animations\n */\nfunction createHandle(animations: Animation[]): AnimationHandle {\n  return {\n    set playbackRate(rate: number) {\n      animations.forEach(animation => {\n        animation.playbackRate = rate;\n      });\n    },\n    setMotionEndCallbacks(onfinish: () => void, oncancel: () => void) {\n      // Heads up!\n      // This could use \"Animation:finished\", but it's causing a memory leak in Chromium.\n      // See: https://issues.chromium.org/u/2/issues/383016426\n      const promises = animations.map(animation => {\n        return new Promise<void>((resolve, reject) => {\n          animation.onfinish = () => resolve();\n          animation.oncancel = () => reject();\n        });\n      });\n\n      Promise.all(promises)\n        .then(() => {\n          onfinish();\n        })\n        .catch(() => {\n          oncancel();\n        });\n    },\n    isRunning() {\n      return animations.some(animation => isAnimationRunning(animation));\n    },\n\n    dispose: () => {\n      animations.length = 0;\n    },\n\n    cancel: () => {\n      animations.forEach(animation => {\n        animation.cancel();\n      });\n    },\n    pause: () => {\n      animations.forEach(animation => {\n        animation.pause();\n      });\n    },\n    play: () => {\n      animations.forEach(animation => {\n        animation.play();\n      });\n    },\n    finish: () => {\n      animations.forEach(animation => {\n        animation.finish();\n      });\n    },\n    reverse: () => {\n      // Heads up!\n      //\n      // This is used for the interruptible motion. If the animation is running, we need to reverse it.\n      //\n      // TODO: what do with animations that have \"delay\"?\n      // TODO: what do with animations that have different \"durations\"?\n\n      animations.forEach(animation => {\n        animation.reverse();\n      });\n    },\n  };\n}\n\nfunction useAnimateAtomsInSupportedEnvironment() {\n  // eslint-disable-next-line @nx/workspace-no-restricted-globals\n  const SUPPORTS_PERSIST = typeof window !== 'undefined' && typeof window.Animation?.prototype.persist === 'function';\n\n  return React.useCallback(\n    (\n      element: HTMLElement,\n      value: AtomMotion | AtomMotion[],\n      options: {\n        isReducedMotion: boolean;\n      },\n    ): AnimationHandle => {\n      const atoms = Array.isArray(value) ? value : [value];\n      const { isReducedMotion } = options;\n\n      const animations = atoms\n        .map(motion => {\n          // Grab the custom reduced motion definition if it exists, or fall back to the default reduced motion.\n          const { keyframes: motionKeyframes, reducedMotion = DEFAULT_REDUCED_MOTION_ATOM, ...params } = motion;\n          // Grab the reduced motion keyframes if they exist, or fall back to the regular keyframes.\n          const { keyframes: reducedMotionKeyframes = motionKeyframes, ...reducedMotionParams } = reducedMotion;\n\n          const animationKeyframes: Keyframe[] = isReducedMotion ? reducedMotionKeyframes : motionKeyframes;\n          const animationParams: KeyframeEffectOptions = {\n            ...DEFAULT_ANIMATION_OPTIONS,\n            ...params,\n\n            // Use reduced motion overrides (e.g. duration, easing) when reduced motion is enabled\n            ...(isReducedMotion && reducedMotionParams),\n          };\n\n          try {\n            // Firefox can throw an error when calling `element.animate()`.\n            // See: https://github.com/microsoft/fluentui/issues/33902\n            const animation = element.animate(animationKeyframes, animationParams);\n\n            if (SUPPORTS_PERSIST) {\n              // Chromium browsers can return null when calling `element.animate()`.\n              // See: https://github.com/microsoft/fluentui/issues/33902\n              animation?.persist();\n            } else {\n              const resultKeyframe = animationKeyframes[animationKeyframes.length - 1];\n              Object.assign(element.style ?? {}, resultKeyframe);\n            }\n\n            return animation;\n          } catch (e) {\n            return null;\n          }\n        })\n        .filter(animation => !!animation) as Animation[];\n\n      return createHandle(animations);\n    },\n    [SUPPORTS_PERSIST],\n  );\n}\n\n/**\n * In test environments, this hook is used to delay the execution of a callback until the next render. This is necessary\n * to ensure that the callback is not executed synchronously, which would cause the test to fail.\n *\n * @see https://github.com/microsoft/fluentui/issues/31701\n */\nfunction useAnimateAtomsInTestEnvironment() {\n  const [count, setCount] = React.useState(0);\n  const callbackRef = React.useRef<() => void>(undefined);\n\n  const realAnimateAtoms = useAnimateAtomsInSupportedEnvironment();\n\n  React.useEffect(() => {\n    if (count > 0) {\n      callbackRef.current?.();\n    }\n  }, [count]);\n\n  return React.useCallback(\n    (\n      element: HTMLElement,\n      value: AtomMotion | AtomMotion[],\n      options: {\n        isReducedMotion: boolean;\n      },\n    ): AnimationHandle => {\n      const ELEMENT_SUPPORTS_WEB_ANIMATIONS = typeof element.animate === 'function';\n\n      // Heads up!\n      // If the environment supports Web Animations API, we can use the native implementation.\n      if (ELEMENT_SUPPORTS_WEB_ANIMATIONS) {\n        return realAnimateAtoms(element, value, options);\n      }\n\n      return {\n        setMotionEndCallbacks(onfinish: () => void) {\n          callbackRef.current = onfinish;\n          setCount(v => v + 1);\n        },\n\n        set playbackRate(rate: number) {\n          /* no-op */\n        },\n        isRunning() {\n          return false;\n        },\n\n        dispose() {\n          /* no-op */\n        },\n\n        cancel() {\n          /* no-op */\n        },\n        pause() {\n          /* no-op */\n        },\n        play() {\n          /* no-op */\n        },\n        finish() {\n          /* no-op */\n        },\n        reverse() {\n          /* no-op */\n        },\n      };\n    },\n    [realAnimateAtoms],\n  );\n}\n\n/**\n * @internal\n */\nexport function useAnimateAtoms(): (\n  element: HTMLElement,\n  value: AtomMotion | AtomMotion[],\n  options: { isReducedMotion: boolean },\n) => AnimationHandle {\n  'use no memo';\n\n  if (process.env.NODE_ENV === 'test') {\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    return useAnimateAtomsInTestEnvironment();\n  }\n\n  // eslint-disable-next-line react-hooks/rules-of-hooks\n  return useAnimateAtomsInSupportedEnvironment();\n}\n"],"names":["React","isAnimationRunning","DEFAULT_ANIMATION_OPTIONS","fill","DEFAULT_REDUCED_MOTION_ATOM","duration","createHandle","animations","playbackRate","rate","forEach","animation","setMotionEndCallbacks","onfinish","oncancel","promises","map","Promise","resolve","reject","all","then","catch","isRunning","some","dispose","length","cancel","pause","play","finish","reverse","useAnimateAtomsInSupportedEnvironment","window","SUPPORTS_PERSIST","Animation","prototype","persist","useCallback","element","value","options","atoms","Array","isArray","isReducedMotion","motion","keyframes","motionKeyframes","reducedMotion","params","reducedMotionKeyframes","reducedMotionParams","animationKeyframes","animationParams","animate","resultKeyframe","Object","assign","style","e","filter","useAnimateAtomsInTestEnvironment","count","setCount","useState","callbackRef","useRef","undefined","realAnimateAtoms","useEffect","current","ELEMENT_SUPPORTS_WEB_ANIMATIONS","v","useAnimateAtoms","process","env","NODE_ENV"],"mappings":"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"}