{"version":3,"sources":["../src/components/Popover/usePopover.ts"],"sourcesContent":["'use client';\n\nimport * as React from 'react';\nimport {\n  useControllableState,\n  useEventCallback,\n  useOnClickOutside,\n  useOnScrollOutside,\n  elementContains,\n  useTimeout,\n} from '@fluentui/react-utilities';\nimport { useFluent_unstable as useFluent } from '@fluentui/react-shared-contexts';\nimport {\n  usePositioning,\n  resolvePositioningShorthand,\n  mergeArrowOffset,\n  usePositioningMouseTarget,\n} from '@fluentui/react-positioning';\nimport { useFocusFinders, useActivateModal } from '@fluentui/react-tabster';\nimport { arrowHeights } from '../PopoverSurface/index';\nimport type {\n  OpenPopoverEvents,\n  PopoverBaseProps,\n  PopoverBaseState,\n  PopoverProps,\n  PopoverState,\n} from './Popover.types';\nimport { popoverSurfaceBorderRadius } from './constants';\n\n/**\n * Create the state required to render Popover.\n *\n * The returned state can be modified with hooks such as usePopoverStyles,\n * before being passed to renderPopover_unstable.\n *\n * @param props - props from this instance of Popover\n */\nexport const usePopover_unstable = (props: PopoverProps): PopoverState => {\n  const { appearance, size = 'medium' } = props;\n  const positioning = resolvePositioningShorthand(props.positioning);\n  const withArrow = props.withArrow && !positioning.coverTarget;\n\n  const state = usePopoverBase_unstable({\n    ...props,\n    positioning: {\n      ...positioning,\n      // Update the offset with the arrow size only when it's available\n      ...(withArrow ? { offset: mergeArrowOffset(positioning.offset, arrowHeights[size]) } : {}),\n    },\n  });\n\n  return {\n    appearance,\n    size,\n    ...state,\n  };\n};\n\n/**\n * Base hook that builds Popover state for behavior and structure only.\n * Does not add design-related defaults such as appearance or size.\n * Does not manage focus behavior, it's handled by `usePopoverFocusManagement_unstable`.\n *\n * @internal\n * @param props - props from this instance of Popover\n */\nexport const usePopoverBase_unstable = (props: PopoverBaseProps): PopoverBaseState => {\n  const [contextTarget, setContextTarget] = usePositioningMouseTarget();\n  const initialState = {\n    contextTarget,\n    setContextTarget,\n    ...props,\n  } as const;\n\n  const children = React.Children.toArray(props.children) as React.ReactElement[];\n\n  if (process.env.NODE_ENV !== 'production') {\n    if (children.length === 0) {\n      // eslint-disable-next-line no-console\n      console.warn('Popover must contain at least one child');\n    }\n\n    if (children.length > 2) {\n      // eslint-disable-next-line no-console\n      console.warn('Popover must contain at most two children');\n    }\n  }\n\n  let popoverTrigger: React.ReactElement | undefined = undefined;\n  let popoverSurface: React.ReactElement | undefined = undefined;\n  if (children.length === 2) {\n    popoverTrigger = children[0];\n    popoverSurface = children[1];\n  } else if (children.length === 1) {\n    popoverSurface = children[0];\n  }\n\n  const [open, setOpenState] = useOpenState(initialState);\n\n  const [setOpenTimeout, clearOpenTimeout] = useTimeout();\n  const setOpen = useEventCallback((e: OpenPopoverEvents, shouldOpen: boolean) => {\n    clearOpenTimeout();\n    if (!(e instanceof Event) && e.persist) {\n      // < React 17 still uses pooled synthetic events\n      e.persist();\n    }\n\n    if (e.type === 'mouseleave') {\n      // FIXME leaking Node timeout type\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      setOpenTimeout(() => {\n        setOpenState(e, shouldOpen);\n      }, props.mouseLeaveDelay ?? 500);\n    } else {\n      setOpenState(e, shouldOpen);\n    }\n  });\n\n  const toggleOpen = React.useCallback<PopoverBaseState['toggleOpen']>(\n    (e: OpenPopoverEvents) => {\n      setOpen(e, !open);\n    },\n    [setOpen, open],\n  );\n\n  const positioningRefs = usePopoverRefs(initialState);\n  const { targetDocument } = useFluent();\n\n  useOnClickOutside({\n    contains: elementContains,\n    element: targetDocument,\n    callback: ev => setOpen(ev, false),\n    refs: [positioningRefs.triggerRef, positioningRefs.contentRef],\n    disabled: !open,\n    disabledFocusOnIframe: !(props.closeOnIframeFocus ?? true),\n  });\n\n  // only close on scroll for context, or when closeOnScroll is specified\n  const closeOnScroll = initialState.openOnContext || initialState.closeOnScroll;\n  useOnScrollOutside({\n    contains: elementContains,\n    element: targetDocument,\n    callback: ev => setOpen(ev, false),\n    refs: [positioningRefs.triggerRef, positioningRefs.contentRef],\n    disabled: !open || !closeOnScroll,\n  });\n\n  const { findFirstFocusable } = useFocusFinders();\n  const activateModal = useActivateModal();\n\n  React.useEffect(() => {\n    if (props.unstable_disableAutoFocus) {\n      return;\n    }\n\n    const contentElement = positioningRefs.contentRef.current;\n\n    if (open && contentElement) {\n      const shouldFocusContainer = !isNaN(contentElement.getAttribute('tabIndex') ?? undefined);\n      const firstFocusable = shouldFocusContainer ? contentElement : findFirstFocusable(contentElement);\n\n      firstFocusable?.focus();\n\n      if (shouldFocusContainer) {\n        // Modal activation happens automatically when something inside the modal is focused programmatically.\n        // When the container is focused, we need to activate the modal manually.\n        activateModal(contentElement);\n      }\n    }\n  }, [findFirstFocusable, activateModal, open, positioningRefs.contentRef, props.unstable_disableAutoFocus]);\n\n  return {\n    ...initialState,\n    ...positioningRefs,\n    // eslint-disable-next-line @typescript-eslint/no-deprecated\n    inertTrapFocus: props.inertTrapFocus ?? (props.legacyTrapFocus === undefined ? false : !props.legacyTrapFocus),\n    popoverTrigger,\n    popoverSurface,\n    open,\n    setOpen,\n    toggleOpen,\n    setContextTarget,\n    contextTarget,\n    inline: props.inline ?? false,\n  };\n};\n\n/**\n * Creates and manages the Popover open state\n */\nfunction useOpenState(\n  state: Pick<PopoverBaseState, 'setContextTarget' | 'onOpenChange'> & Pick<PopoverBaseProps, 'open' | 'defaultOpen'>,\n) {\n  'use no memo';\n\n  const onOpenChange: PopoverBaseState['onOpenChange'] = useEventCallback((e, data) => state.onOpenChange?.(e, data));\n\n  const [open, setOpenState] = useControllableState({\n    state: state.open,\n    defaultState: state.defaultOpen,\n    initialState: false,\n  });\n  state.open = open !== undefined ? open : state.open;\n  const setContextTarget = state.setContextTarget;\n\n  const setOpen = React.useCallback(\n    (e: OpenPopoverEvents, shouldOpen: boolean) => {\n      if (shouldOpen && e.type === 'contextmenu') {\n        setContextTarget(e as React.MouseEvent);\n      }\n\n      if (!shouldOpen) {\n        setContextTarget(undefined);\n      }\n\n      setOpenState(shouldOpen);\n      onOpenChange?.(e, { open: shouldOpen });\n    },\n    [setOpenState, onOpenChange, setContextTarget],\n  );\n\n  return [open, setOpen] as const;\n}\n\n/**\n * Creates and sets the necessary trigger, target and content refs used by Popover\n */\nfunction usePopoverRefs(\n  state: Pick<PopoverBaseState, 'contextTarget'> &\n    Pick<PopoverBaseProps, 'positioning' | 'openOnContext' | 'withArrow'>,\n) {\n  'use no memo';\n\n  const positioningOptions = {\n    position: 'above' as const,\n    align: 'center' as const,\n    arrowPadding: 2 * popoverSurfaceBorderRadius,\n    target: state.openOnContext ? state.contextTarget : undefined,\n    ...resolvePositioningShorthand(state.positioning),\n  };\n\n  // no reason to render arrow when covering the target\n  if (positioningOptions.coverTarget) {\n    state.withArrow = false;\n  }\n\n  const { targetRef: triggerRef, containerRef: contentRef, arrowRef } = usePositioning(positioningOptions);\n\n  return {\n    triggerRef,\n    contentRef,\n    arrowRef,\n  } as const;\n}\n"],"names":["React","useControllableState","useEventCallback","useOnClickOutside","useOnScrollOutside","elementContains","useTimeout","useFluent_unstable","useFluent","usePositioning","resolvePositioningShorthand","mergeArrowOffset","usePositioningMouseTarget","useFocusFinders","useActivateModal","arrowHeights","popoverSurfaceBorderRadius","usePopover_unstable","props","appearance","size","positioning","withArrow","coverTarget","state","usePopoverBase_unstable","offset","contextTarget","setContextTarget","initialState","children","Children","toArray","process","env","NODE_ENV","length","console","warn","popoverTrigger","undefined","popoverSurface","open","setOpenState","useOpenState","setOpenTimeout","clearOpenTimeout","setOpen","e","shouldOpen","Event","persist","type","mouseLeaveDelay","toggleOpen","useCallback","positioningRefs","usePopoverRefs","targetDocument","contains","element","callback","ev","refs","triggerRef","contentRef","disabled","disabledFocusOnIframe","closeOnIframeFocus","closeOnScroll","openOnContext","findFirstFocusable","activateModal","useEffect","unstable_disableAutoFocus","contentElement","current","shouldFocusContainer","isNaN","getAttribute","firstFocusable","focus","inertTrapFocus","legacyTrapFocus","inline","onOpenChange","data","defaultState","defaultOpen","positioningOptions","position","align","arrowPadding","target","targetRef","containerRef","arrowRef"],"mappings":"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"}